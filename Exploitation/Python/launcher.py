import numpy as np
import ctypes as ct
from time import time
import matplotlib.pyplot as plt
from multiprocessing import Process
from multiprocessing import Manager

import database as db

def run():
    j = 0
    for i in range(start, end, step):
        results = c_library.evacuate(i)
        print(f"results {results}")
        nb_indivlist[j] += results % 10000 #Nb d'indiv au départ
        nb_iterationlist[j] += results // 10000 #Nb d'itérations
        j += 1

c_library = ct.CDLL("../C++/main.so")
database = db.Database("./options.db")
Opt = database.getLast()

nb_pylons = 0

start, end, step, avg, pylons = Opt


print("Les derniers paramètres sont :")
print("Bornes :")
print(f"  Début : {start}\n  Fin : {end}")
print(f"Step : {step}")
print(f"Avg : {avg} séries")

if len(pylons)==0:
    print("Aucun pylône n'est placé")
else:
    print(f"Il y a {len(pylons)} pylônes en ")
    for i in pylons:
        print(i)

if input("Souhaitez vous changer ces paramètres ? [y/N] ") == "y":
    start = int(input("Nombre d'individus minimal : "))
    end = int(input("Nombre d'individus maximal : "))
    step = int(input("Pas : "))
    avg = int(input("Nombre de simulations : "))


    if input("Souhaitez-vous mettre des pylones ? [y/N] ") == "y":
        pylons = []
        nb_pylons = int(input("Nombre de pylones : "))

        if nb_pylons  > 0:
            print("Les positions doivent être entée avec le format : x,y")
            for i in range(nb_pylons):
                xy = input(f"Position du pylône {i+1} : ")
                pylons.append([int(i) for i in xy.split(',')])
    else:
        pylons = []

    database.addValue(start, end, step, avg, pylons)

for pylon in pylons:
    x,y = pylon
    c_library.preaddPylones(x, y)


nb_points = (end-start)//step
nb_indivlist = Manager().list([0]*nb_points)
nb_iterationlist = Manager().list([0]*nb_points)

process_list = []
print(avg)
for i in range(avg):
    process_list.append(Process(target = run))

t0 = time()
for process in process_list:
    process.start()
for process in process_list:
    process.join()
print(f"Temps d'execution : {time()-t0}")


print("Génération du graphe...")
plt.title("Résultat de la simulation")
plt.plot(np.array(nb_iterationlist)/avg,np.array(nb_indivlist)/avg)
plt.xlabel("Nombre d'itérations")
plt.ylabel("Nombre d'individus")

plt.show()
